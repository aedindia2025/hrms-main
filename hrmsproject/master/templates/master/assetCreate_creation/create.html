{% extends 'base.html' %}
{% load static %}

{% block title %}Asset Create Creation - Create{% endblock %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}

<div class="dashboard-main-body">

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <!-- Link to Create Page -->
    <h6 class="mb-3 fw-bold text-secondary">Master / <span class="text-dark"> Asset creation Create</span></h6>
     <button  onclick="history.back()" class="btn-back">
   <i data-feather="arrow-left"></i> Back
</button>
</div>


 <div class="card shadow-sm">
        <div class="card-body">
            <form action="" method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}

                   <div class="row g-3">
        
        <!-- Date -->
        <div class="col-md-3">
          <label for="date" class="form-label">Date <span class="text-danger">*</span></label>
          <input type="date" name="date" id="date" class="form-control" required>
        </div>
       
          <div class="col-md-3">
          <label for="site_name" class="form-label">Site name <span class="text-danger">*</span></label>
          <select name="site_name" id="site_name" class="form-select" required>
            <option value="">Select Site</option>
            {% for site in sites %}
              <option value="{{ site.pk }}">{{ site.name }}</option>
            {% endfor %}
          </select>
        </div>

          <div class="col-md-3">
          <label for="staff_name" class="form-label">Staff name <span class="text-danger">*</span></label>
          <select name="staff_name" id="staff_name" class="form-select" required>
            <option value="">Select Employee</option>
            {% for employee in employees %}
              <option value="{{ employee.pk }}">{{ employee.staff_name }} ({{ employee.staff_id }})</option>
            {% endfor %}
          </select>
        </div>
        <!-- Asset Type -->
        <div class="col-md-3">
          <label for="assetType" class="form-label">Asset Type <span class="text-danger">*</span></label>
          <select name="asset_type" id="assetType" class="form-select" required>
            <option value="">Select Asset Type</option>
            {% for asset_type in asset_types %}
              <option value="{{ asset_type.pk }}">{{ asset_type.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Serial No / Item No -->
        <div class="col-md-3">
          <label for="serialNo" class="form-label">Serial No / Item No <span class="text-danger">*</span></label>
          <input type="text" name="serial_no" id="serialNo" class="form-control" placeholder="Enter Serial No" required>
        </div>

        <!-- Quantity -->
        <div class="col-md-3">
          <label for="qty" class="form-label">Qty <span class="text-danger">*</span></label>
          <input type="number" name="quantity" id="qty" class="form-control" placeholder="Enter Quantity" min="1" value="1" required>
        </div>

        <!-- Status -->
        <div class="col-md-3">
          <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
          <select name="status" id="status" class="form-select" required>
            <option value="">Select Status</option>
            <option value="Issued">Issued</option>
            <option value="Returned">Returned</option>
            <option value="In Repair">In Repair</option>
          </select>
        </div>

        <!-- Image Upload -->
        <div class="col-md-3">
          <label for="imageUpload" class="form-label">Image Upload</label>
          <input name="image" class="form-control" type="file" id="imageUpload" accept="image/*">
        </div>

        <!-- Description -->
        <div class="col-md-6">
          <label for="description" class="form-label">Description</label>
          <textarea name="description" id="description" class="form-control" rows="3" placeholder="Enter Description"></textarea>
        </div>

        <!-- Buttons -->
        <div class="col-md-12 text-end mt-2" >
          <button type="button" class="btn btn-success" id="addBtn">ADD</button>
        </div>

      </div>
           <p class="mb-3 fs-4 fw-bold">Sub List</p>
      <div class="table-responsive  mt-3">
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>S.No</th>
                            <th>Entry Date</th>
                            <th>Site Name</th>
                            <th>Staff Name</th>
                            <th>Asset type</th>
                            <th>Serial No / Item No</th>
                            <th>QTY</th>
                            <th>Status</th>
                            <th>Description</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="subListTbody">   
                        <tr id="emptyRow">
                            <td colspan="10" class="text-center text-muted">No items added yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

                <!-- Buttons -->
                <div class="mt-5 d-flex justify-content-end gap-2">
                    <button type="submit" class="btn btn-success px-4">Submit</button>
                    <a href="{% url 'master:asset_create_list' %}" class="btn btn-danger px-4">Cancel</a>
                </div>
            </form>


    </div>
</div>
</div>

    <!-- Card -->
<style>
    .btn-back {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background-color: #28a745; /* green shade */
  color: #fff !important;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  text-decoration: none;
  transition: 0.2s ease-in-out;
}

.btn-back:hover {
  background-color: #218838; /* darker green */
  color: #fff !important;
  text-decoration: none;
}

.btn-back i {
  font-size: 14px;
}
.select2-container--default .select2-selection--multiple {
    min-height: 38px;                /* same as Bootstrap input */
    border: 1px solid #ced4da;       /* Bootstrap border */
    border-radius: 0.375rem;         /* Bootstrap rounded */
    padding: 4px 6px;
    width: 100% !important;          /* full width inside col-md-6 */
}

/* Align the rendered text like form-control */
.select2-container--default .select2-selection--multiple .select2-selection__rendered {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

/* Style the selected badges */
.select2-container--default .select2-selection__choice {
    background-color: #0d6efd !important; /* Bootstrap primary */
    border: none !important;
    color: #fff !important;
    padding: 2px 8px;
    border-radius: 0.25rem;
    font-size: 0.85rem;
}

/* Remove default Ã— icon background */
.select2-container--default .select2-selection__choice__remove {
    color: #fff !important;
    margin-right: 4px;
}
    </style>
     
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="https://unpkg.com/feather-icons"></script>
<script id="assetCreationScript_v5_20240127" type="text/javascript">
    // ============================================
    // ASSET CREATION - VERSION 5.0 - NO CACHE
    // NO innerHTML - FORCE RELOAD - TIMESTAMP: 2024-01-27
    // ============================================
    console.log('========================================');
    console.log('Asset Creation Script v5.0 - STARTING');
    console.log('NO innerHTML version - Fresh load');
    console.log('TIMESTAMP: ' + new Date().getTime());
    console.log('========================================');
    
    // FORCE DELETE ALL old cached functions
    try {
        delete window.refreshSubListTable;
        delete window.addToSubList;
        delete window.removeFromSubList;
        delete window.clearForm;
        delete window.formatDate;
        delete window.addHiddenInputs;
        delete window.refreshSubListTable_v4;
        delete window.refreshSubListTable_v3;
        delete window.refreshSubListTable_v2;
        // Clear any old variables
        window.assetCreationSubListItems = undefined;
        window.subListItems = undefined;
        console.log('All old functions and variables cleared');
    } catch(e) {
        console.log('Clearing old code:', e);
    }
    
    feather.replace();
    
    // Global variables
    var assetCreationSubListItems = [];
    var assetCreationItemCounter = 0;
    var assetCreationEditingItemId = null; // Track which item is being edited
    
    // ============================================
    // ADD TO SUB LIST
    // ============================================
    window.addToSubList = function() {
        console.log('addToSubList called');
        try {
            var date = document.getElementById('date').value;
            var siteName = document.getElementById('site_name');
            var staffName = document.getElementById('staff_name');
            var assetType = document.getElementById('assetType');
            var serialNo = document.getElementById('serialNo').value;
            var qty = document.getElementById('qty').value;
            var status = document.getElementById('status').value;
            var description = document.getElementById('description').value;
            
            if (!date || !siteName.value || !staffName.value || !assetType.value || !serialNo || !qty || !status) {
                alert('Please fill all required fields (Date, Site, Staff, Asset Type, Serial No, Qty, Status)');
                return false;
            }
            
            var siteNameText = siteName.options[siteName.selectedIndex].text;
            var staffNameText = staffName.options[staffName.selectedIndex].text;
            var assetTypeText = assetType.options[assetType.selectedIndex].text;
            
            var item = {
                id: assetCreationEditingItemId || ++assetCreationItemCounter,
                date: date,
                site_id: siteName.value,
                site_name: siteNameText,
                staff_id: staffName.value,
                staff_name: staffNameText,
                asset_type_id: assetType.value,
                asset_type_name: assetTypeText,
                serial_no: serialNo,
                quantity: qty,
                status: status,
                description: description
            };
            
            // If editing, update existing item; otherwise add new
            if (assetCreationEditingItemId) {
                var index = assetCreationSubListItems.findIndex(function(i) {
                    return i.id === assetCreationEditingItemId;
                });
                if (index !== -1) {
                    assetCreationSubListItems[index] = item;
                    console.log('Item updated. ID:', assetCreationEditingItemId);
                    assetCreationEditingItemId = null; // Reset editing state
                    document.getElementById('addBtn').textContent = 'ADD';
                } else {
                    // Item not found in list - add as new item instead
                    console.warn('Item with ID ' + assetCreationEditingItemId + ' not found. Adding as new item.');
                    alert('The item being edited was not found. It will be added as a new item.');
                    assetCreationSubListItems.push(item);
                    assetCreationEditingItemId = null; // Reset editing state
                    document.getElementById('addBtn').textContent = 'ADD';
                }
            } else {
                assetCreationSubListItems.push(item);
                console.log('Item added. Total:', assetCreationSubListItems.length);
            }
            
            setTimeout(function() {
                window.refreshSubListTable();
            }, 50);
            
            window.clearForm();
            return true;
        } catch (error) {
            console.error('Error in addToSubList:', error);
            alert('Error adding item. Check console.');
            return false;
        }
    };
    
    // ============================================
    // EDIT SUB LIST ITEM
    // ============================================
    window.editSubListItem = function(itemId) {
        console.log('editSubListItem called for ID:', itemId);
        var item = assetCreationSubListItems.find(function(i) {
            return i.id === itemId;
        });
        
        if (!item) {
            alert('Item not found.');
            return;
        }
        
        // Populate form with item data
        document.getElementById('date').value = item.date || '';
        document.getElementById('site_name').value = item.site_id || '';
        document.getElementById('staff_name').value = item.staff_id || '';
        document.getElementById('assetType').value = item.asset_type_id || '';
        document.getElementById('serialNo').value = item.serial_no || '';
        document.getElementById('qty').value = item.quantity || '1';
        document.getElementById('status').value = item.status || '';
        document.getElementById('description').value = item.description || '';
        
        // Set editing mode
        assetCreationEditingItemId = itemId;
        document.getElementById('addBtn').textContent = 'UPDATE';
        
        // Scroll to form
        document.getElementById('date').scrollIntoView({ behavior: 'smooth', block: 'center' });
        document.getElementById('date').focus();
        
        console.log('Form populated for editing. Item ID:', itemId);
    };
    
    // ============================================
    // REFRESH SUB LIST TABLE - v5.0 - NO innerHTML EVER
    // ============================================
    window.refreshSubListTable = function() {
        console.log('=== refreshSubListTable v5.0 START (NO innerHTML) ===');
        
        if (document.readyState === 'loading') {
            setTimeout(window.refreshSubListTable, 50);
            return;
        }
        
        try {
            var tbody = document.getElementById('subListTbody');
            if (!tbody) {
                console.error('subListTbody NOT FOUND');
                setTimeout(function() {
                    var retry = document.getElementById('subListTbody');
                    if (retry) {
                        window.refreshSubListTable();
                    } else {
                        alert('Table not found. Refresh page (Ctrl+Shift+R).');
                    }
                }, 300);
                return;
            }
            
            if (!tbody.parentNode) {
                console.error('tbody not connected to DOM');
                return;
            }
            
            console.log('Tbody found. Clearing rows...');
            
            // Clear rows - ONLY removeChild, NO innerHTML
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }
            
            if (!tbody || !tbody.parentNode) {
                console.error('tbody lost after clearing');
                return;
            }
            
            // Empty state
            if (assetCreationSubListItems.length === 0) {
                var emptyRow = document.createElement('tr');
                emptyRow.id = 'emptyRow';
                var emptyCell = document.createElement('td');
                emptyCell.setAttribute('colspan', '10');
                emptyCell.className = 'text-center text-muted';
                emptyCell.textContent = 'No items added yet.';
                emptyRow.appendChild(emptyCell);
                tbody.appendChild(emptyRow);
                return;
            }
            
            // Add items - NO innerHTML
            console.log('Adding', assetCreationSubListItems.length, 'items');
            for (var idx = 0; idx < assetCreationSubListItems.length; idx++) {
                var item = assetCreationSubListItems[idx];
                
                if (!tbody || !tbody.parentNode) {
                    console.error('tbody lost during loop');
                    break;
                }
                
                var tr = document.createElement('tr');
                
                // Create cells using createElement and textContent ONLY
                var cellTexts = [
                    String(idx + 1),
                    window.formatDate(item.date) || '-',
                    item.site_name || '-',
                    item.staff_name || '-',
                    item.asset_type_name || '-',
                    item.serial_no || '-',
                    item.quantity || '-',
                    item.status || '-',
                    item.description || '-'
                ];
                
                for (var c = 0; c < cellTexts.length; c++) {
                    var td = document.createElement('td');
                    td.textContent = cellTexts[c];
                    tr.appendChild(td);
                }
                
                // Action cell with Edit and Remove buttons
                var actionTd = document.createElement('td');
                
                // Edit button
                var editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'btn btn-sm btn-primary me-2';
                editBtn.title = 'Edit';
                editBtn.addEventListener('click', function(id) {
                    return function() {
                        window.editSubListItem(id);
                    };
                }(item.id));
                var editIcon = document.createElement('i');
                editIcon.setAttribute('data-feather', 'edit');
                editBtn.appendChild(editIcon);
                actionTd.appendChild(editBtn);
                
                // Remove button
                var removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-danger';
                removeBtn.title = 'Remove';
                removeBtn.addEventListener('click', function(id) {
                    return function() {
                        window.removeFromSubList(id);
                    };
                }(item.id));
                var removeIcon = document.createElement('i');
                removeIcon.setAttribute('data-feather', 'trash-2');
                removeBtn.appendChild(removeIcon);
                actionTd.appendChild(removeBtn);
                
                tr.appendChild(actionTd);
                
                tbody.appendChild(tr);
            }
            
            // Reinit icons
            if (typeof feather !== 'undefined') {
                setTimeout(function() {
                    feather.replace();
                }, 150);
            }
            
            window.addHiddenInputs();
            console.log('=== refreshSubListTable v5.0 COMPLETE ===');
            
        } catch (error) {
            console.error('EXCEPTION in refreshSubListTable v5.0:', error);
            console.error('Error details:', error);
            alert('Error updating table. Check console. Please refresh page (Ctrl+Shift+R).');
        }
    };
    
    // ============================================
    // REMOVE FROM SUB LIST
    // ============================================
    window.removeFromSubList = function(itemId) {
        if (confirm('Are you sure you want to remove this item?')) {
            assetCreationSubListItems = assetCreationSubListItems.filter(function(item) {
                return item.id !== itemId;
            });
            window.refreshSubListTable();
        }
    };
    
    // ============================================
    // CLEAR FORM
    // ============================================
    window.clearForm = function() {
        document.getElementById('date').value = '';
        document.getElementById('site_name').value = '';
        document.getElementById('staff_name').value = '';
        document.getElementById('assetType').value = '';
        document.getElementById('serialNo').value = '';
        document.getElementById('qty').value = '1';
        document.getElementById('status').value = '';
        document.getElementById('description').value = '';
        document.getElementById('imageUpload').value = '';
        
        // Reset editing state
        if (assetCreationEditingItemId) {
            assetCreationEditingItemId = null;
            document.getElementById('addBtn').textContent = 'ADD';
        }
    };
    
    // ============================================
    // FORMAT DATE
    // ============================================
    window.formatDate = function(dateString) {
        if (!dateString) return '-';
        try {
            var date = new Date(dateString + 'T00:00:00');
            if (isNaN(date.getTime())) {
                return dateString;
            }
            var day = String(date.getDate()).padStart(2, '0');
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var year = date.getFullYear();
            return day + '-' + month + '-' + year;
        } catch (e) {
            return dateString;
        }
    };
    
    // ============================================
    // ADD HIDDEN INPUTS
    // ============================================
    window.addHiddenInputs = function() {
        var existingInputs = document.querySelectorAll('input[name^="items["]');
        existingInputs.forEach(function(input) {
            input.remove();
        });
        
        // First, remove any existing hidden inputs from previous submit attempts
        var existingInputs = document.querySelectorAll('input[name^="items["]');
        existingInputs.forEach(function(input) {
            input.remove();
        });
        
        // Now create hidden inputs for all items in sub-list
        assetCreationSubListItems.forEach(function(item, index) {
            var form = document.querySelector('form');
            var fields = ['date', 'site_id', 'staff_id', 'asset_type_id', 'serial_no', 'quantity', 'status', 'description'];
            
            fields.forEach(function(field) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'items[' + index + '][' + field + ']';
                input.value = item[field] || '';
                form.appendChild(input);
            });
        });
    };
    
    // ============================================
    // INITIALIZE ON PAGE LOAD
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - Initializing v5.0 (NO innerHTML)');
        
        var tbodyCheck = document.getElementById('subListTbody');
        if (!tbodyCheck) {
            console.error('Table tbody not found on page load!');
        } else {
            console.log('Table tbody found on page load');
        }
        
        var today = new Date().toISOString().split('T')[0];
        var dateField = document.getElementById('date');
        if (dateField) {
            dateField.value = today;
        }
        
        setTimeout(function() {
            window.refreshSubListTable();
        }, 100);
        
        var form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Check if sub-list has items
                if (assetCreationSubListItems.length === 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert('Please add at least one item to the sub-list before submitting.');
                    return false;
                }
                
                // Add hidden inputs for all items in sub-list
                window.addHiddenInputs();
                
                // Allow form submission
                console.log('Form submitting with', assetCreationSubListItems.length, 'item(s)');
                return true;
            });
        }
        
        var addButton = document.getElementById('addBtn');
        if (addButton) {
            addButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('ADD button clicked');
                window.addToSubList();
                return false;
            });
        } else {
            console.error('ADD button not found!');
        }
        
        console.log('========================================');
        console.log('Asset Creation Script v5.0 - INITIALIZED');
        console.log('VERIFIED: NO innerHTML usage');
        console.log('========================================');
    });
    
    // Final verification - check if any innerHTML exists in our code
    setTimeout(function() {
        var allScripts = document.querySelectorAll('script[id^="assetCreationScript"]');
        console.log('Found', allScripts.length, 'asset creation script(s)');
        if (allScripts.length > 1) {
            console.warn('WARNING: Multiple asset creation scripts found. Clear cache!');
        }
    }, 500);
</script>
{% endblock %}
