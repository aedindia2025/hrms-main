{% extends 'base.html' %}
{% load static %}

{% block title %}TADA Entry - Create{% endblock %}

{% block content %}

<div class="dashboard-main-body">

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <!-- Link to Create Page -->
     <h6 class="mb-3 fw-bold text-secondary">Entry / <span class="text-dark">Tada Entry Create </span></h6>

     <button  onclick="history.back()" class="btn-back">
   <i data-feather="arrow-left"></i> Back
</button>
</div>


 <div class="card shadow-sm">
        <div class="card-body">
           <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- Main Entry Fields -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Expense Date <span class="text-danger">*</span></label>
                        <input type="date" name="expense_date" class="form-control" value="{{ values.expense_date }}" required>
                        {% if errors.expense_date %}
                            <div class="text-danger small">{{ errors.expense_date }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Batch No</label>
                        <input type="text" name="batch_no" class="form-control" value="{{ values.batch_no }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Site <span class="text-danger">*</span></label>
                        <select name="site" class="form-select" required>
                            <option value="">Select Site</option>
                            {% for site in sites %}
                                <option value="{{ site.id }}" {% if values.site|stringformat:"s" == site.id|stringformat:"s" %}selected{% endif %}>
                                    {{ site.name }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if errors.site %}
                            <div class="text-danger small">{{ errors.site }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Employee <span class="text-danger">*</span></label>
                        <select name="employee" class="form-select" required>
                            <option value="">Select Employee</option>
                            {% for employee in employees %}
                                <option value="{{ employee.id }}" {% if values.employee|stringformat:"s" == employee.id|stringformat:"s" %}selected{% endif %}>
                                    {{ employee.staff_name }} - {{ employee.staff_id }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if errors.employee %}
                            <div class="text-danger small">{{ errors.employee }}</div>
                        {% endif %}
                    </div>
                </div>
                
        <div class="row g-3">

          <!-- Expense Item Form -->
       <div class="col-md-3">
  <label class="form-label">Expense Type <span class="text-danger">*</span></label>
  <div class="custom-select-wrapper">
    <input type="text" id="expenseTypeInput" class="custom-select-input" placeholder="Search or Select" readonly>
    <input type="hidden" id="expenseTypeId">
    <div class="custom-select-dropdown" id="expenseTypeDropdown">
      {% if expense_types %}
        {% for expense_type in expense_types %}
          <div data-value="{{ expense_type.name }}" data-id="{{ expense_type.id }}">{{ expense_type.name }}</div>
        {% endfor %}
      {% else %}
        <div data-value="Drinking Water Expenses">Drinking Water Expenses</div>
        <div data-value="Food Expenses Special">Food Expenses Special</div>
        <div data-value="Food Expenses">Food Expenses</div>
        <div data-value="Lodging Expenses">Lodging Expenses</div>
        <div data-value="Miscallaneous Expenses">Miscallaneous Expenses</div>
        <div data-value="Staff Refreshment">Staff Refreshment</div>
        <div data-value="Staff Welfare Expenses">Staff Welfare Expenses</div>
        <div data-value="Tollgate Expenses">Tollgate Expenses</div>
        <div data-value="Travelling Expenses">Travelling Expenses</div>
      {% endif %}
    </div>
  </div>
</div>
        <div class="col-md-3">
        <label class="form-label">Sub Expense Type <span class="text-danger">*</span></label>
  <div class="custom-select-wrapper">
    <input type="text" id="subExpenseTypeInput" class="custom-select-input" placeholder="Search or Select" readonly>
    <input type="hidden" id="subExpenseTypeId">
    <div class="custom-select-dropdown" id="subExpenseTypeDropdown">
      {% if sub_expense_types %}
        {% for sub_expense_type in sub_expense_types %}
          <div data-value="{{ sub_expense_type.name }}" data-id="{{ sub_expense_type.id }}">{{ sub_expense_type.name }}</div>
        {% endfor %}
      {% else %}
        <div data-value="Bike Own">Bike Own</div>
        <div data-value="Bike Rental">Bike Rental</div>
        <div data-value="Bus">Bus</div>
        <div data-value="Car CNG">Car CNG</div>
        <div data-value="Car Petrol">Car Petrol</div>
        <div data-value="Car Rental">Car Rental</div>
        <div data-value="Taxi/Auto">Taxi/Auto</div>
        <div data-value="Train">Train</div>
      {% endif %}
    </div>
  </div>
          </div>
          <div class="col-md-3">
            <label class="form-label">From Location <span class="text-danger">*</span></label>
            <input type="text" id="fromLocation" class="form-control">
          </div>
        <div class="col-md-3">
            <label class="form-label">To Location <span class="text-danger">*</span></label>
            <input type="text" id="toLocation" class="form-control">
          </div>
        <div class="col-md-3">
            <label class="form-label">Start Meter</label>
            <input type="number" step="0.01" id="startMeter" class="form-control">
          </div>
        <div class="col-md-3">
            <label class="form-label">End Meter</label>
            <input type="number" step="0.01" id="endMeter" class="form-control">
          </div>
         <div class="col-md-3">
            <label class="form-label">Total Kilometer</label>
            <input type="number" step="0.01" id="totalKilometer" class="form-control" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label">Amount <span class="text-danger">*</span></label>
            <input type="number" step="0.01" id="amount" class="form-control">
          </div>
   <div class="col-md-3">
    <label class="form-label">Upload Image</label>
    <input class="form-control" type="file" id="uploadImage" accept="image/*">
    </div>
    <div class="col-md-3">
    <label class="form-label">Meter Upload Image</label>
    <input class="form-control" type="file" id="meterUploadImage" accept="image/*">
    </div>
          <div class="col-md-6">
            <label class="form-label">Description</label>
            <textarea id="description" class="form-control" rows="3"></textarea>
          </div>
        <div class="col-md-2 d-flex align-items-center mb-3 gap-2">
        <button type="button" id="updateBtn" class="btn btn-success" style="display: none;">Update</button>
        <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display: none;">Cancel</button>
      </div>
        </div>

        <!-- Available Permissions -->
       <div class="container " style="margin-top:40px;">

       <p class="fw-bold fs-6 text-uppercase">TADA Sub List</p>
       {% if errors.sub_items %}
         <div class="alert alert-danger mt-2">
           <strong>Error:</strong> {{ errors.sub_items }}
         </div>
       {% endif %}
  <!-- Table Wrapper -->
  <div id="tableWrapper" class="table-responsive">
    <table class="balance-table" id="recordsTable">
      <thead>
        <tr>
          <th>Expense Type</th>
          <th>Sub Expense Type</th>
          <th>From Location</th>
          <th>To Location</th>
          <th>Amount</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Initially No Records -->
        <tr id="noRecordsRow"  class="table-success">
          <td colspan="6" class="no-records text-center">No Records Found</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>






                <!-- Buttons -->
                <div class="mt-5 d-flex justify-content-end gap-2">
                    <button type="submit" class="btn btn-success px-4">Submit</button>
                    <a href="{% url 'entry:tada_entry_list' %}" class="btn btn-danger px-4">Cancel</a>
                </div>
            </form>


    </div>
</div>
</div>

    <!-- Card -->
<style>
    .btn-back {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background-color: #28a745; /* green shade */
  color: #fff !important;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  text-decoration: none;
  transition: 0.2s ease-in-out;
}

.btn-back:hover {
  background-color: #218838; /* darker green */
  color: #fff !important;
  text-decoration: none;
}

.btn-back i {
  font-size: 14px;
}
.form-check .form-check-input{
    margin-top:7px;
    margin-right:6px;
}
.details-box {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
    }
    .details-box  li i {
  vertical-align: middle;
}
.custom-select-wrapper {
    position: relative;
    width: 100%;
    font-family: Arial, sans-serif;
  }

  .custom-select-input {
    width: 100%;
    padding: 8px 30px 8px 8px; /* space for arrow */
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    cursor: pointer;
  }

  /* Dropdown arrow */
  .custom-select-wrapper::after {
    content: "";
    position: absolute;
    top: 50%;
    right: 10px;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid #555;
    transform: translateY(-50%);
    pointer-events: none;
  }

  .custom-select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 150px;
    border: 1px solid #ccc;
    border-top: none;
    background: #fff;
    overflow-y: auto;
    display: none;
    z-index: 1000;
  }

  .custom-select-dropdown div {
    padding: 8px;
    cursor: pointer;
  }

  .custom-select-dropdown div:hover {
    background-color: #a4c8feff;
    color:#000;

  }
  #recordsTable {
    overflow: hidden;
  }
  .table-success {
    background-color: #28a745 !important; /* Green theme */
    color: #fff;
  }
  .no-records {
    background: #edd4d4ff;
    color: #d01616ff;
    font-weight: bold;
    text-align: center;
  }
  .balance-table {
    width: 100%;
    border-collapse: collapse;
}

.balance-table th,
.balance-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
    font-size: 14px;
}

.balance-table th {
    background-color: #f9f9f9ff;
    font-weight: bold;
    color: #333;
}
    </style>
     

<script src="https://unpkg.com/feather-icons@4.29.2/dist/feather.min.js"></script>
<script>
  // Wait for DOM to be ready before replacing icons
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
    });
  } else {
    if (typeof feather !== 'undefined') {
      feather.replace();
    }
  }
  
  // Store sub-items data in array (like asset creation)
  let tadaSubListItems = [];
  let tadaItemCounter = 0;
  
  // Variable to track which item is being edited
  let editingItemId = null;
  
  // Restore sub-items if validation failed
  const restoredItems = JSON.parse('{{ restored_sub_items_json|escapejs }}');
  
  // Initialize with restored items if any
  if (restoredItems && restoredItems.length > 0) {
    restoredItems.forEach((item) => {
      tadaSubListItems.push({
        id: tadaItemCounter++,
        expense_type_id: item.expense_type_id,
        expense_type_name: item.expense_type_name || 'Unknown',
        sub_expense_type_id: item.sub_expense_type_id || '',
        sub_expense_type_name: item.sub_expense_type_name || '',
        from_location: item.from_location || '',
        to_location: item.to_location || '',
        start_meter: item.start_meter || '',
        end_meter: item.end_meter || '',
        total_kilometer: item.total_kilometer || '',
        amount: item.amount || '',
        description: item.description || ''
      });
    });
  }
  
  // Refresh sublist table from array (following employee creation pattern)
  function refreshSubListTable() {
    const tableBody = document.querySelector("#recordsTable tbody");
    if (!tableBody) {
      console.error('Table tbody not found');
      return;
    }
    
    // Clear table using innerHTML (like employee creation)
    tableBody.innerHTML = '';
    
    // If no items, show empty message
    if (tadaSubListItems.length === 0) {
      tableBody.innerHTML = '<tr id="noRecordsRow" class="table-success"><td colspan="6" class="no-records text-center">No Records Found</td></tr>';
      return;
    }
    
    // Add items from array using innerHTML (simpler, like employee creation)
    tadaSubListItems.forEach((item, index) => {
      const row = document.createElement('tr');
      row.id = `row-${item.id}`;
      row.innerHTML = `
        <td>${item.expense_type_name || '-'}</td>
        <td>${item.sub_expense_type_name || '-'}</td>
        <td>${item.from_location || '-'}</td>
        <td>${item.to_location || '-'}</td>
        <td>â‚¹${parseFloat(item.amount || 0).toFixed(2)}</td>
        <td>
          <button type="button" class="btn btn-sm btn-primary me-1" onclick="editItem(${item.id})" title="Edit">
            <i data-feather="edit-2"></i>
          </button>
          <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(${item.id})" title="Delete">
            <i data-feather="trash-2"></i>
          </button>
        </td>
      `;
      tableBody.appendChild(row);
    });
    
    // Replace icons after table is updated
    if (typeof feather !== 'undefined') {
      feather.replace();
    }
  }
  
  // Add hidden inputs on form submit (following employee creation pattern)
  function addHiddenInputs() {
    // Remove existing hidden inputs
    const existingInputs = document.querySelectorAll('input[name^="sub_items_"]');
    existingInputs.forEach(input => input.remove());
    
    // Add hidden inputs for all items
    const form = document.querySelector('form');
    if (!form) {
      console.error('Form not found!');
      return false;
    }
    
    // Validate items before adding inputs
    for (let i = 0; i < tadaSubListItems.length; i++) {
      const item = tadaSubListItems[i];
      if (!item.expense_type_id || !item.sub_expense_type_id || !item.amount || !item.from_location || !item.to_location) {
        console.error(`Item ${i} is missing required fields:`, item);
        return false;
      }
    }
    
    // Add hidden inputs for all items (same format as backend expects)
    tadaSubListItems.forEach((item) => {
      const fields = {
        'sub_items_expense_type[]': item.expense_type_id,
        'sub_items_sub_expense_type[]': item.sub_expense_type_id || '',
        'sub_items_from_location[]': item.from_location,
        'sub_items_to_location[]': item.to_location,
        'sub_items_start_meter[]': item.start_meter || '',
        'sub_items_end_meter[]': item.end_meter || '',
        'sub_items_total_kilometer[]': item.total_kilometer || '',
        'sub_items_amount[]': item.amount,
        'sub_items_description[]': item.description || ''
      };
      
      Object.keys(fields).forEach(fieldName => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = fieldName;
        input.value = String(fields[fieldName] || '');
        form.appendChild(input);
      });
    });
    
    return true;
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    refreshSubListTable();
  });

  const addBtn = document.getElementById("addBtn");
  const updateBtn = document.getElementById("updateBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const tableBody = document.querySelector("#recordsTable tbody");
  const noRecordsRow = document.getElementById("noRecordsRow");
  
  // Cancel edit button event
  if (cancelEditBtn) {
    cancelEditBtn.addEventListener("click", function(e) {
      e.preventDefault();
      cancelEdit();
    });
  }

  // Calculate total kilometer
  function calculateTotalKm() {
    const startMeter = parseFloat(document.getElementById("startMeter").value) || 0;
    const endMeter = parseFloat(document.getElementById("endMeter").value) || 0;
    const totalKmInput = document.getElementById("totalKilometer");
    
    if (startMeter && endMeter) {
      if (endMeter >= startMeter) {
        totalKmInput.value = (endMeter - startMeter).toFixed(2);
      } else {
        // Handle meter rollover
        totalKmInput.value = ((999999 - startMeter) + endMeter).toFixed(2);
      }
    } else {
      totalKmInput.value = '';
    }
  }

  document.getElementById("startMeter").addEventListener("input", calculateTotalKm);
  document.getElementById("endMeter").addEventListener("input", calculateTotalKm);

  // Function to add or update item
  function addOrUpdateItem() {
    // Get form values
    const expenseType = document.getElementById("expenseTypeInput").value;
    const expenseTypeId = document.getElementById("expenseTypeId").value;
    const subExpenseType = document.getElementById("subExpenseTypeInput").value;
    const subExpenseTypeId = document.getElementById("subExpenseTypeId").value;
    const fromLocation = document.getElementById("fromLocation").value;
    const toLocation = document.getElementById("toLocation").value;
    const startMeter = document.getElementById("startMeter").value;
    const endMeter = document.getElementById("endMeter").value;
    const totalKilometer = document.getElementById("totalKilometer").value;
    const amount = document.getElementById("amount").value;
    const description = document.getElementById("description").value;

    // Validation
    if (!expenseType || !expenseTypeId) {
      alert("Please select an Expense Type");
      return;
    }
    if (!subExpenseType || !subExpenseTypeId) {
      alert("Please select a Sub Expense Type");
      return;
    }
    if (!fromLocation || !toLocation) {
      alert("Please enter From and To locations");
      return;
    }
    if (!amount || parseFloat(amount) <= 0) {
      alert("Please enter a valid amount");
      return;
    }

    if (editingItemId !== null && editingItemId !== undefined) {
      // Update existing item - find and replace
      const index = tadaSubListItems.findIndex(i => i.id === editingItemId);
      if (index !== -1) {
        // Update existing item with same ID
        tadaSubListItems[index] = {
          id: editingItemId,
          expense_type_id: expenseTypeId,
          expense_type_name: expenseType,
          sub_expense_type_id: subExpenseTypeId || '',
          sub_expense_type_name: subExpenseType || '',
          from_location: fromLocation,
          to_location: toLocation,
          start_meter: startMeter || '',
          end_meter: endMeter || '',
          total_kilometer: totalKilometer || '',
          amount: amount,
          description: description || ''
        };
        
        // Reset editing state
        editingItemId = null;
        
        // Show Add button, hide Update and Cancel buttons
        document.getElementById("addBtn").style.display = 'inline-block';
        document.getElementById("updateBtn").style.display = 'none';
        document.getElementById("cancelEditBtn").style.display = 'none';
      } else {
        alert('Error: Item not found for updating. Please try again.');
        return;
      }
    } else {
      // Add new item
      const item = {
        id: tadaItemCounter++,
        expense_type_id: expenseTypeId,
        expense_type_name: expenseType,
        sub_expense_type_id: subExpenseTypeId || '',
        sub_expense_type_name: subExpenseType || '',
        from_location: fromLocation,
        to_location: toLocation,
        start_meter: startMeter || '',
        end_meter: endMeter || '',
        total_kilometer: totalKilometer || '',
        amount: amount,
        description: description || ''
      };
      tadaSubListItems.push(item);
    }
    
    // Refresh table
    refreshSubListTable();

    // Clear form
    const expenseTypeInputEl = document.getElementById("expenseTypeInput");
    const expenseTypeIdEl = document.getElementById("expenseTypeId");
    if (expenseTypeInputEl && expenseTypeIdEl) {
      expenseTypeInputEl.value = '';
      expenseTypeIdEl.value = '';
      expenseTypeInputEl.setAttribute("readonly", true);
    }
    
    const subExpenseTypeInputEl = document.getElementById("subExpenseTypeInput");
    const subExpenseTypeIdEl = document.getElementById("subExpenseTypeId");
    if (subExpenseTypeInputEl && subExpenseTypeIdEl) {
      subExpenseTypeInputEl.value = '';
      subExpenseTypeIdEl.value = '';
      subExpenseTypeInputEl.setAttribute("readonly", true);
    }
    
    document.getElementById("fromLocation").value = '';
    document.getElementById("toLocation").value = '';
    document.getElementById("startMeter").value = '';
    document.getElementById("endMeter").value = '';
    document.getElementById("totalKilometer").value = '';
    document.getElementById("amount").value = '';
    document.getElementById("description").value = '';
    document.getElementById("uploadImage").value = '';
    document.getElementById("meterUploadImage").value = '';
  }
  
  // Add to sublist
  addBtn.addEventListener("click", function (e) {
    e.preventDefault();
    addOrUpdateItem();
  });
  
  // Update item
  if (updateBtn) {
    updateBtn.addEventListener("click", function (e) {
      e.preventDefault();
      addOrUpdateItem();
    });
  }

  // Edit item function
  window.editItem = function(itemId) {
    // Find the item in the array
    const item = tadaSubListItems.find(i => i.id === itemId);
    if (!item) {
      alert('Item not found');
      return;
    }
    
    // Set editing mode
    editingItemId = itemId;
    
    // Populate form fields with item data
    const expenseTypeInput = document.getElementById("expenseTypeInput");
    const expenseTypeId = document.getElementById("expenseTypeId");
    if (expenseTypeInput && expenseTypeId) {
      expenseTypeInput.value = item.expense_type_name || '';
      expenseTypeId.value = item.expense_type_id || '';
      expenseTypeInput.removeAttribute("readonly");
    }
    
    const subExpenseTypeInput = document.getElementById("subExpenseTypeInput");
    const subExpenseTypeId = document.getElementById("subExpenseTypeId");
    if (subExpenseTypeInput && subExpenseTypeId) {
      subExpenseTypeInput.value = item.sub_expense_type_name || '';
      subExpenseTypeId.value = item.sub_expense_type_id || '';
      subExpenseTypeInput.removeAttribute("readonly");
    }
    
    document.getElementById("fromLocation").value = item.from_location || '';
    document.getElementById("toLocation").value = item.to_location || '';
    document.getElementById("startMeter").value = item.start_meter || '';
    document.getElementById("endMeter").value = item.end_meter || '';
    document.getElementById("totalKilometer").value = item.total_kilometer || '';
    document.getElementById("amount").value = item.amount || '';
    document.getElementById("description").value = item.description || '';
    
    // Show Update and Cancel buttons, hide Add button
    document.getElementById("addBtn").style.display = 'none';
    document.getElementById("updateBtn").style.display = 'inline-block';
    document.getElementById("cancelEditBtn").style.display = 'inline-block';
    
    // Scroll to form fields
    if (expenseTypeInput) {
      expenseTypeInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };
  
  // Cancel edit function
  window.cancelEdit = function() {
    editingItemId = null;
    
    // Clear form fields
    const expenseTypeInput = document.getElementById("expenseTypeInput");
    const expenseTypeId = document.getElementById("expenseTypeId");
    if (expenseTypeInput && expenseTypeId) {
      expenseTypeInput.value = '';
      expenseTypeId.value = '';
      expenseTypeInput.setAttribute("readonly", true);
    }
    
    const subExpenseTypeInput = document.getElementById("subExpenseTypeInput");
    const subExpenseTypeId = document.getElementById("subExpenseTypeId");
    if (subExpenseTypeInput && subExpenseTypeId) {
      subExpenseTypeInput.value = '';
      subExpenseTypeId.value = '';
      subExpenseTypeInput.setAttribute("readonly", true);
    }
    
    document.getElementById("fromLocation").value = '';
    document.getElementById("toLocation").value = '';
    document.getElementById("startMeter").value = '';
    document.getElementById("endMeter").value = '';
    document.getElementById("totalKilometer").value = '';
    document.getElementById("amount").value = '';
    document.getElementById("description").value = '';
    document.getElementById("uploadImage").value = '';
    document.getElementById("meterUploadImage").value = '';
    
    // Show Add button, hide Update and Cancel buttons
    document.getElementById("addBtn").style.display = 'inline-block';
    document.getElementById("updateBtn").style.display = 'none';
    document.getElementById("cancelEditBtn").style.display = 'none';
  };
  
  // Remove item function
  window.removeItem = function(itemId) {
    if (confirm("Are you sure you want to remove this item?")) {
      // If editing this item, cancel edit first
      if (editingItemId === itemId) {
        cancelEdit();
      }
      
      // Remove from array
      tadaSubListItems = tadaSubListItems.filter(item => item.id !== itemId);
      
      // Refresh table
      refreshSubListTable();
    }
  };

  // Form submission validation (following employee creation pattern)
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function(e) {
      // Check if there are any items in the sublist
      if (tadaSubListItems.length === 0) {
        e.preventDefault();
        e.stopPropagation();
        alert('Please add at least one expense item to the sublist before submitting.');
        return false;
      }
      
      // Validate all items have required fields
      const invalidItems = tadaSubListItems.filter(item => 
        !item.expense_type_id || !item.sub_expense_type_id || !item.amount || !item.from_location || !item.to_location
      );
      
      if (invalidItems.length > 0) {
        e.preventDefault();
        e.stopPropagation();
        alert('Some items are missing required fields (Expense Type, Sub Expense Type, From Location, To Location, or Amount). Please check and try again.');
        return false;
      }
      
      // Add hidden inputs for all items before submitting
      const success = addHiddenInputs();
      
      if (!success) {
        e.preventDefault();
        e.stopPropagation();
        alert('Error: Could not prepare form data. Please try again.');
        return false;
      }
      
      // Allow form to submit normally
      return true;
    });
  }

  // Update custom select to store IDs
  document.querySelectorAll(".custom-select-wrapper").forEach(wrapper => {
    const input = wrapper.querySelector(".custom-select-input");
    const hiddenInput = wrapper.querySelector("input[type='hidden']");
    const dropdown = wrapper.querySelector(".custom-select-dropdown");

    // Show/hide dropdown on click
    input.addEventListener("click", () => {
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
      input.removeAttribute("readonly");
      input.focus();
    });

    // Filter items while typing
    input.addEventListener("input", () => {
      const filter = input.value.toLowerCase();
      const options = dropdown.querySelectorAll("div");
      options.forEach(opt => {
        opt.style.display = opt.textContent.toLowerCase().includes(filter) ? "block" : "none";
      });
    });

    // Select option
    dropdown.addEventListener("click", e => {
      if (e.target.dataset.value) {
        input.value = e.target.dataset.value;
        if (hiddenInput && e.target.dataset.id) {
          hiddenInput.value = e.target.dataset.id;
        }
        dropdown.style.display = "none";
        input.setAttribute("readonly", true);
      }
    });

    // Close dropdown if clicked outside
    document.addEventListener("click", e => {
      if (!wrapper.contains(e.target)) {
        dropdown.style.display = "none";
        input.setAttribute("readonly", true);
      }
    });
  });
</script>
{% endblock %}
