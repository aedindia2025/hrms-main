{% extends 'base.html' %}
{% load static %}

{% block title %}Travel Requisition - Edit{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="dashboard-main-body">

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 fw-bold text-secondary">Entry / <span class="text-dark">Travel Requisition Edit</span></h6>
        <a href="{% url 'entry:travel_entry_list' %}" class="btn-back">
            <i data-feather="arrow-left"></i> Back
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="travel-card">
    
                <!-- Travel Form -->
                <form method="POST" action="{% url 'entry:travel_entry_edit' travel_entry.pk %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Hidden inputs for travel_mode and trip_type (must be inside form) -->
                    <input type="hidden" name="travel_mode" id="travel_mode" value="{{ values.travel_mode }}" required>
                    <input type="hidden" name="trip_type" id="trip_type" value="{{ values.trip_type }}" required>
                    
                    <!-- Tabs -->
                    <div class="d-flex justify-content-center gap-3 mb-3 travel-tabs" id="travelModeTabs">
                        <button type="button" class="btn {% if values.travel_mode == 'bus' %}active{% endif %}" data-mode="bus">Bus</button>
                        <button type="button" class="btn {% if values.travel_mode == 'train' %}active{% endif %}" data-mode="train">Train</button>
                        <button type="button" class="btn {% if values.travel_mode == 'cab' %}active{% endif %}" data-mode="cab">Cab</button>
                        <button type="button" class="btn {% if values.travel_mode == 'flight' %}active{% endif %}" data-mode="flight">Flight</button>
                    </div>

                    <!-- Trip Type -->
                    <div class="d-flex justify-content-center gap-2 mb-3 trip-type" id="tripTypeTabs">
                        <button type="button" class="btn {% if values.trip_type == 'one_way' %}active{% endif %}" data-trip="one_way">One Way</button>
                        <button type="button" class="btn {% if values.trip_type == 'return' %}active{% endif %}" data-trip="return">Return</button>
                    </div>
                    
                    {% if errors %}
                        <div class="alert alert-danger mb-3">
                            <ul class="mb-0">
                                {% for field, error in errors.items %}
                                    <li><strong>{{ field }}:</strong> {{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>Employee <span class="text-danger">*</span></label>
                            <select name="employee" class="form-select" required>
                                <option value="">Select Employee</option>
                                {% for emp in employees %}
                                    <option value="{{ emp.id }}" {% if values.employee == emp.id|stringformat:"s" %}selected{% endif %}>{{ emp.staff_name }}</option>
                                {% endfor %}
                            </select>
                            {% if errors.employee %}
                                <div class="text-danger small mt-1">{{ errors.employee }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label>Site <span class="text-danger">*</span></label>
                            <select name="site" class="form-select" required>
                                <option value="">Select Site</option>
                                {% for site in sites %}
                                    <option value="{{ site.id }}" {% if values.site == site.id|stringformat:"s" %}selected{% endif %}>{{ site.name }}</option>
                                {% endfor %}
                            </select>
                            {% if errors.site %}
                                <div class="text-danger small mt-1">{{ errors.site }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label>Booking Needed? <span class="text-danger">*</span></label><br>
                            <input type="radio" name="booking_option" id="booking_frontdesk" value="front_desk" {% if values.booking_option == 'front_desk' %}checked{% endif %} required>
                            <label for="booking_frontdesk">Front Desk <small style="color: gray;">(Office arranges travel)</small></label>
                            &nbsp;&nbsp;
                            <input type="radio" name="booking_option" id="booking_self" value="self" {% if values.booking_option == 'self' %}checked{% endif %}>
                            <label for="booking_self">Self <small style="color: gray;">(You arrange travel)</small></label>
                            {% if errors.booking_option %}
                                <div class="text-danger small mt-1">{{ errors.booking_option }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label>Accommodation Type</label><br>
                            <input type="radio" name="accommodation_type" id="accommodation_hotel" value="hotel" {% if values.accommodation_type == 'hotel' %}checked{% endif %}>
                            <label for="accommodation_hotel">Hotel</label>
                            &nbsp;&nbsp;
                            <input type="radio" name="accommodation_type" id="accommodation_guest_house" value="guest_house" {% if values.accommodation_type == 'guest_house' %}checked{% endif %}>
                            <label for="accommodation_guest_house">Guest House</label>
                        </div>

                        <div class="col-md-6">
                            <label>From <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" name="from_location" class="form-control" placeholder="Enter departure city" value="{{ values.from_location }}" required>
                                <span class="input-group-text bg-white"><i class="fa-solid fa-location-dot text-muted"></i></span>
                            </div>
                            {% if errors.from_location %}
                                <div class="text-danger small mt-1">{{ errors.from_location }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-5">
                            <label>To <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" name="to_location" class="form-control" placeholder="Enter destination" value="{{ values.to_location }}" required>
                                <span class="input-group-text bg-white"><i class="fa-solid fa-location-dot text-muted"></i></span>
                            </div>
                            {% if errors.to_location %}
                                <div class="text-danger small mt-1">{{ errors.to_location }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-1 text-end">
                            <label class="invisible">Swap</label><br>
                            <button type="button" class="btn btn-outline-secondary rounded-circle" id="swapLocations">
                                â‡„
                            </button>
                        </div>

                        <div class="col-md-6">
                            <label>Departure Date <span class="text-danger">*</span></label>
                            <input type="date" name="departure_date" class="form-control" value="{{ values.departure_date }}" required>
                            {% if errors.departure_date %}
                                <div class="text-danger small mt-1">{{ errors.departure_date }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label>Departure Time <span class="text-danger">*</span></label>
                            <input type="time" name="departure_time" class="form-control" value="{{ values.departure_time }}" required>
                            {% if errors.departure_time %}
                                <div class="text-danger small mt-1">{{ errors.departure_time }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6" id="returnDateField" style="{% if values.trip_type == 'return' %}display:block;{% else %}display:none;{% endif %}">
                            <label>Return Date <span class="text-danger">*</span></label>
                            <input type="date" name="return_date" class="form-control" value="{{ values.return_date }}">
                            {% if errors.return_date %}
                                <div class="text-danger small mt-1">{{ errors.return_date }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6" id="returnTimeField" style="{% if values.trip_type == 'return' %}display:block;{% else %}display:none;{% endif %}">
                            <label>Return Time <span class="text-danger">*</span></label>
                            <input type="time" name="return_time" class="form-control" value="{{ values.return_time }}">
                            {% if errors.return_time %}
                                <div class="text-danger small mt-1">{{ errors.return_time }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label>No of Days <span class="text-danger">*</span></label>
                            <input type="number" name="no_of_days" class="form-control" min="1" value="{{ values.no_of_days }}" required>
                            {% if errors.no_of_days %}
                                <div class="text-danger small mt-1">{{ errors.no_of_days }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label>Travel Reason <span class="text-danger">*</span></label>
                            <select name="travel_reason" class="form-select" required>
                                <option value="">Select Reason</option>
                                <option value="business_trip" {% if values.travel_reason == 'business_trip' %}selected{% endif %}>Business Trip</option>
                                <option value="home_town_visit" {% if values.travel_reason == 'home_town_visit' %}selected{% endif %}>Quarterly Home Town Visit</option>
                            </select>
                            {% if errors.travel_reason %}
                                <div class="text-danger small mt-1">{{ errors.travel_reason }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Purpose Of Visit <span class="text-danger">*</span></label>
                            <textarea name="purpose_of_visit" class="form-control" rows="2" required>{{ values.purpose_of_visit }}</textarea>
                            {% if errors.purpose_of_visit %}
                                <div class="text-danger small mt-1">{{ errors.purpose_of_visit }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Aadhar Upload <small class="text-muted">(Optional)</small></label>
                            {% if travel_entry.aadhar_upload %}
                                <div class="mb-2">
                                    <small>Current: <a href="{{ travel_entry.aadhar_upload.url }}" target="_blank">View</a></small>
                                </div>
                            {% endif %}
                            <input class="form-control" type="file" name="aadhar_upload" accept="image/*">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Upload One Way Document <small class="text-muted">(Optional)</small></label>
                            {% if travel_entry.one_way_document %}
                                <div class="mb-2">
                                    <small>Current: <a href="{{ travel_entry.one_way_document.url }}" target="_blank">View</a></small>
                                </div>
                            {% endif %}
                            <input class="form-control" type="file" name="one_way_document" accept="image/*">
                        </div>

                        <div class="row justify-content-center mt-3">
                            <div class="col-3">
                                <button type="submit" class="btn submit-btn">Update</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    input[type="radio"] {
        appearance: auto !important;
        -webkit-appearance: radio !important;
        margin-right: 4px;
    }
    body {
        background: #f7f8fa;
    }
    .card {
        border-radius: 10px;
        border: 1px solid #e0e0e0;
    }
    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        background: #fff;
        border: 1px solid #dee2e6;
        color: #495057;
        text-decoration: none;
        transition: 0.2s ease-in-out;
    }
    .btn-back:hover {
        background: #f8f9fa;
        color: #212529;
        text-decoration: none;
    }
    .travel-card {
        padding: 15px;
        max-width: 100%;
    }
    .travel-tabs .btn {
        border-radius: 50px;
        padding: 8px 25px;
        font-weight: 500;
        border: 2px solid #146c43;
        color: #020202ff;
        background: #fff;
        transition: 0.3s;
    }
    .travel-tabs .btn.active, 
    .travel-tabs .btn:hover {
        background: #146c43;
        color: #fff;
    }
    .trip-type .btn {
        border-radius: 30px;
        padding: 6px 20px;
        border: 1px solid #dee2e6;
        background: #fff;
        color: #146c43;
        font-weight: 500;
    }
    .trip-type .btn.active {
        background: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
    }
    .form-control, .form-select {
        border-radius: 12px;
    }
    .submit-btn {
        background: #146c43;
        border: none;
        color:#fff;
        border-radius: 12px;
        padding: 12px;
        font-size: 16px;
        font-weight: 600;
        width: 100%;
        transition: 0.3s;
    }
    .submit-btn:hover {
        background: #0b5232;
        color:#fff;
    }
    label {
        font-weight: 500;
        margin-bottom: 5px;
    }
</style>

<script src="https://unpkg.com/feather-icons"></script>
<script>
    feather.replace();

    // Travel Mode Selection
    document.querySelectorAll('#travelModeTabs .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#travelModeTabs .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('travel_mode').value = this.dataset.mode;
        });
    });

    // Trip Type Selection
    document.querySelectorAll('#tripTypeTabs .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#tripTypeTabs .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const tripType = this.dataset.trip;
            document.getElementById('trip_type').value = tripType;
            
            const returnDateField = document.getElementById('returnDateField');
            const returnTimeField = document.getElementById('returnTimeField');
            if (tripType === 'return') {
                returnDateField.style.display = 'block';
                returnTimeField.style.display = 'block';
                returnDateField.querySelector('input').required = true;
                returnTimeField.querySelector('input').required = true;
            } else {
                returnDateField.style.display = 'none';
                returnTimeField.style.display = 'none';
                returnDateField.querySelector('input').required = false;
                returnTimeField.querySelector('input').required = false;
            }
        });
    });

    // Swap Locations
    document.getElementById('swapLocations').addEventListener('click', function() {
        const fromInput = document.querySelector('input[name="from_location"]');
        const toInput = document.querySelector('input[name="to_location"]');
        const temp = fromInput.value;
        fromInput.value = toInput.value;
        toInput.value = temp;
    });
</script>

{% endblock %}

